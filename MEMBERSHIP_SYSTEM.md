# Membership-Based Loan & Booking System

## Overview

The system now differentiates between **membership users** and **non-membership users** when creating book loans and room bookings.

### Key Features

1. **Automatic Approval for Members** - Active membership users get instant approval
2. **Payment Gateway for Non-Members** - Non-members must pay commitment fees
3. **Global User Limits** - Maximum active loans and bookings per user
4. **Fair Access Control** - Prevents abuse and ensures availability

---

## User Limits Configuration

Located in `config/limits.ts`:

```typescript
export const USER_LIMITS = {
  MAX_ACTIVE_BOOK_LOANS: 3, // Max 3 active book loans per user
  MAX_ACTIVE_ROOM_BOOKINGS: 1, // Max 1 active room booking per user
  DEFAULT_LOAN_DURATION_DAYS: 7, // 7 days loan period
  LATE_FEES_PER_DAY: 5000, // Rp 5,000 per day late fee
  COMMITMENT_FEE_BOOK_LOAN: 50000, // Rp 50,000 commitment fee for book loans
  COMMITMENT_FEE_ROOM_BOOKING: 100000, // Rp 100,000 commitment fee for room bookings
};
```

---

## Book Loan Flow

### For **Membership Users** (Active Membership)

#### Request

```bash
POST /api/book-loans
Content-Type: application/json

{
  "userId": "507f1f77bcf86cd799439011",
  "bookId": "507f1f77bcf86cd799439012"
}
```

#### Response (201 Created)

```json
{
  "success": true,
  "membershipApproved": true,
  "message": "Book loan created and auto-approved (active membership)",
  "data": {
    "id": "...",
    "userId": "...",
    "bookId": "...",
    "loanDate": "2024-11-17T10:00:00.000Z",
    "dueDate": "2024-11-24T10:00:00.000Z",
    "status": "ACTIVE",
    "fine": 0,
    "lateFeesPerDay": 5000,
    "book": { "title": "...", "author": "...", "isbn": "..." },
    "user": { "name": "...", "email": "..." }
  }
}
```

**Benefits:**

- ‚úÖ Instant approval (status = `ACTIVE`)
- ‚úÖ No commitment fee required
- ‚úÖ Book availability updated immediately

---

### For **Non-Membership Users**

#### Request

```bash
POST /api/book-loans
Content-Type: application/json

{
  "userId": "507f1f77bcf86cd799439013",
  "bookId": "507f1f77bcf86cd799439012"
}
```

#### Response (402 Payment Required)

```json
{
  "success": false,
  "membershipRequired": false,
  "message": "Payment required. Please complete the commitment fee payment to proceed.",
  "paymentDetails": {
    "type": "COMMITMENT_FEE",
    "amount": 50000,
    "description": "Commitment fee for book loan"
    // "midtransToken": "<will be generated by Midtrans>" // TODO
  }
}
```

**What Happens:**

- ‚ùå Loan NOT created yet
- üí≥ Payment required before approval
- üîÑ After payment: Call `/api/book-loans/complete-payment` (to be implemented)

---

## Room Booking Flow

### For **Membership Users** (Active Membership)

#### Request

```bash
POST /api/rooms/bookings
Content-Type: application/json

{
  "userId": "507f1f77bcf86cd799439011",
  "roomId": "507f1f77bcf86cd799439014",
  "bookingDate": "2024-11-20T00:00:00.000Z",
  "startTime": "2024-11-20T09:00:00.000Z",
  "endTime": "2024-11-20T11:00:00.000Z",
  "purpose": "Team meeting"
}
```

#### Response (201 Created)

```json
{
  "success": true,
  "membershipApproved": true,
  "message": "Room booked and auto-confirmed (active membership)",
  "data": {
    "id": "...",
    "userId": "...",
    "roomId": "...",
    "bookingDate": "2024-11-20T00:00:00.000Z",
    "startTime": "2024-11-20T09:00:00.000Z",
    "endTime": "2024-11-20T11:00:00.000Z",
    "duration": 2,
    "totalCost": 200000,
    "status": "CONFIRMED",
    "paymentStatus": "PAID",
    "room": { "name": "...", "type": "...", "hourlyRate": 100000 },
    "user": { "name": "...", "email": "...", "phoneNumber": "..." }
  }
}
```

**Benefits:**

- ‚úÖ Instant confirmation (status = `CONFIRMED`)
- ‚úÖ Auto-marked as paid (paymentStatus = `PAID`)
- ‚úÖ No commitment fee required

---

### For **Non-Membership Users**

#### Request

```bash
POST /api/rooms/bookings
Content-Type: application/json

{
  "userId": "507f1f77bcf86cd799439013",
  "roomId": "507f1f77bcf86cd799439014",
  "bookingDate": "2024-11-20T00:00:00.000Z",
  "startTime": "2024-11-20T09:00:00.000Z",
  "endTime": "2024-11-20T11:00:00.000Z",
  "purpose": "Study session"
}
```

#### Response (402 Payment Required)

```json
{
  "success": false,
  "membershipRequired": false,
  "message": "Payment required. Please complete the commitment fee and booking fee payment to proceed.",
  "paymentDetails": {
    "type": "ROOM_BOOKING",
    "amount": 300000,
    "commitmentFee": 100000,
    "bookingFee": 200000,
    "description": "Room booking fee + commitment fee"
    // "midtransToken": "<will be generated by Midtrans>" // TODO
  }
}
```

**What Happens:**

- ‚ùå Booking NOT created yet
- üí≥ Payment required: Commitment fee (Rp 100k) + Booking fee (Rp 200k)
- üîÑ After payment: Call `/api/rooms/bookings/complete-payment` (to be implemented)

---

## Active Limits Validation

### Book Loans Limit

**Rule:** Maximum **3 active book loans** per user

```javascript
// Example: User already has 3 active loans
POST /api/book-loans

// Response (400 Bad Request)
{
  "success": false,
  "message": "Maximum active book loans reached (3 loans per user)"
}
```

**Count Logic:**

```typescript
const activeLoanCount = await prisma.bookLoan.count({
  where: {
    userId: userId,
    status: "ACTIVE",
  },
});

if (activeLoanCount >= 3) {
  // Reject new loan request
}
```

---

### Room Booking Limit

**Rule:** Maximum **1 active room booking** per user

```javascript
// Example: User already has 1 active booking
POST /api/rooms/bookings

// Response (400 Bad Request)
{
  "success": false,
  "message": "Maximum active room bookings reached (1 booking per user)"
}
```

**Count Logic:**

```typescript
const activeBookingCount = await prisma.roomBooking.count({
  where: {
    userId: userId,
    status: { in: ["PENDING", "CONFIRMED"] },
  },
});

if (activeBookingCount >= 1) {
  // Reject new booking request
}
```

---

## Membership Check Logic

### How Active Membership is Determined

```typescript
const user = await prisma.user.findUnique({
  where: { id: userId },
  include: { membership: true },
});

const hasActiveMembership = Boolean(
  user.membership?.isActive && user.membership.endDate > new Date() // Membership must be active // End date must be in future
);
```

### Membership Required Fields

From `schema.prisma`:

```prisma
model Membership {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  userId           String   @db.ObjectId @unique
  membershipNumber String   @unique
  startDate        DateTime @default(now())
  endDate          DateTime    // ‚Üê Must be > current date
  isActive         Boolean  @default(true) // ‚Üê Must be true
  // ...
}
```

---

## Payment Integration (TODO)

### Midtrans Payment Gateway

**Current Status:** ‚è≥ Placeholder implemented

**Next Steps:**

1. Install Midtrans SDK
2. Generate payment token in POST endpoint
3. Create payment completion endpoint
4. Verify payment status
5. Create loan/booking after successful payment

### Implementation Plan

```typescript
// TODO: Install midtrans-client
// npm install midtrans-client

import midtransClient from "midtrans-client";

const snap = new midtransClient.Snap({
  isProduction: false,
  serverKey: process.env.MIDTRANS_SERVER_KEY,
  clientKey: process.env.MIDTRANS_CLIENT_KEY,
});

// Generate payment token
const transaction = await snap.createTransaction({
  transaction_details: {
    order_id: `LOAN-${Date.now()}`,
    gross_amount: USER_LIMITS.COMMITMENT_FEE_BOOK_LOAN,
  },
  customer_details: {
    email: user.email,
    first_name: user.name,
    phone: user.phoneNumber,
  },
});

// Return token to frontend
return res.status(402).json({
  paymentDetails: {
    midtransToken: transaction.token,
    midtransRedirectUrl: transaction.redirect_url,
    amount: USER_LIMITS.COMMITMENT_FEE_BOOK_LOAN,
  },
});
```

---

## Error Scenarios

### 1. Maximum Loans Reached

```json
{
  "success": false,
  "message": "Maximum active book loans reached (3 loans per user)"
}
```

### 2. Maximum Bookings Reached

```json
{
  "success": false,
  "message": "Maximum active room bookings reached (1 booking per user)"
}
```

### 3. User Not Found

```json
{
  "success": false,
  "message": "User not found"
}
```

### 4. Book/Room Not Available

```json
{
  "success": false,
  "message": "Book not available for loan"
}
```

### 5. Duplicate Active Loan

```json
{
  "success": false,
  "message": "User already has an active loan for this book"
}
```

### 6. Time Slot Conflict

```json
{
  "success": false,
  "message": "Time slot conflicts with existing booking"
}
```

---

## Testing Examples

### Test Case 1: Member Creates Loan

```bash
# Prerequisite: User has active membership
curl -X POST http://localhost:8080/api/book-loans \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "MEMBER_USER_ID",
    "bookId": "BOOK_ID"
  }'

# Expected: 201 Created, loan auto-approved
```

### Test Case 2: Non-Member Creates Loan

```bash
# Prerequisite: User has NO active membership
curl -X POST http://localhost:8080/api/book-loans \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "NON_MEMBER_USER_ID",
    "bookId": "BOOK_ID"
  }'

# Expected: 402 Payment Required, payment details returned
```

### Test Case 3: Exceed Loan Limit

```bash
# Prerequisite: User already has 3 active loans
curl -X POST http://localhost:8080/api/book-loans \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "USER_WITH_3_LOANS",
    "bookId": "BOOK_ID"
  }'

# Expected: 400 Bad Request, max limit reached
```

---

## Configuration Updates

### Environment Variables (Add to `.env`)

```bash
# Midtrans Configuration (TODO)
MIDTRANS_SERVER_KEY=your-server-key
MIDTRANS_CLIENT_KEY=your-client-key
MIDTRANS_IS_PRODUCTION=false
```

---

## Database Schema Updates

The schema already includes the necessary models:

‚úÖ `User` model with `membership` relation  
‚úÖ `Membership` model with `isActive` and `endDate` fields  
‚úÖ `BookLoan` model with `status` field  
‚úÖ `RoomBooking` model with `status` and `paymentStatus` fields  
‚úÖ `CommitmentFee` model for tracking fees (relations already set)

---

## Frontend Integration Guide

### Check User Membership Before Loan/Booking

```javascript
// 1. Get user details with membership
const user = await fetch(`/api/users/${userId}`).then((r) => r.json());

// 2. Check membership status
const hasActiveMembership =
  user.data.membership?.isActive &&
  new Date(user.data.membership.endDate) > new Date();

// 3. Show appropriate UI
if (hasActiveMembership) {
  showInstantApprovalUI();
} else {
  showPaymentRequiredUI();
}
```

### Handle Payment Response

```javascript
// Non-member loan creation
const response = await fetch("/api/book-loans", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ userId, bookId }),
});

if (response.status === 402) {
  const data = await response.json();

  // TODO: Integrate Midtrans Snap
  // window.snap.pay(data.paymentDetails.midtransToken, {
  //   onSuccess: () => completeLoan(),
  //   onPending: () => showPendingMessage(),
  //   onError: () => showErrorMessage()
  // });

  showPaymentModal(data.paymentDetails);
} else if (response.status === 201) {
  // Member: Auto-approved
  showSuccessMessage("Loan approved!");
}
```

---

## Next Steps (TODO)

- [ ] Integrate Midtrans payment gateway
- [ ] Create payment completion endpoints
- [ ] Add payment verification webhooks
- [ ] Implement commitment fee refund logic
- [ ] Add payment history tracking
- [ ] Create admin dashboard for payment monitoring
- [ ] Add email notifications for payments
- [ ] Implement payment retry logic
- [ ] Add payment status tracking

---

## Benefits Summary

### For Membership Users

- ‚úÖ **Instant approval** - No waiting for payment
- ‚úÖ **No commitment fees** - Save money
- ‚úÖ **Better user experience** - Seamless process
- ‚úÖ **Priority access** - Auto-confirmed bookings

### For Non-Membership Users

- ‚úÖ **Still accessible** - Can use services with payment
- ‚úÖ **Fair pricing** - Commitment fee ensures responsibility
- ‚úÖ **Secure transactions** - Midtrans payment gateway
- ‚úÖ **Flexible options** - Can upgrade to membership anytime

### For Library Management

- ‚úÖ **Abuse prevention** - Limits prevent hoarding
- ‚úÖ **Revenue generation** - Commitment fees from non-members
- ‚úÖ **Better tracking** - Clear member vs non-member distinction
- ‚úÖ **Resource optimization** - Fair distribution of books/rooms
